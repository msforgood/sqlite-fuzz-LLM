#!/bin/bash -eu
# Quick exploit testing script

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
EXPLOIT_DIR="$ROOT_DIR/exploit"

echo "=== SQLite3 Exploit Quick Test ==="
echo "WARNING: For defensive security research only!"
echo ""

# Build exploits
echo "[+] Building exploits..."
if "$EXPLOIT_DIR/scripts/build_exploits.sh"; then
    echo "[+] Build completed"
else
    echo "[-] Build failed"
    exit 1
fi

echo ""
echo "[+] Running quick exploit tests..."

# Run each exploit with short timeout for testing
EXPLOITS=(
    "btree_overflow_exploit"
    "vdbe_uaf_exploit"
    "format_string_exploit"
    "wal_race_exploit"
)

for exploit in "${EXPLOITS[@]}"; do
    echo ""
    echo "--- Testing $exploit ---"
    
    # Run with 10 second timeout for quick test
    if timeout 10 "$EXPLOIT_DIR/bin/$exploit" > /dev/null 2>&1; then
        echo "[+] $exploit: Completed successfully"
    else
        exit_code=$?
        case $exit_code in
            124)
                echo "[+] $exploit: Timed out (expected for stress tests)"
                ;;
            139)
                echo "[!] $exploit: SEGFAULT detected (potential vulnerability)"
                ;;
            134)
                echo "[!] $exploit: ABORT detected (potential vulnerability)"
                ;;
            1)
                echo "[!] $exploit: Reported vulnerability detection"
                ;;
            *)
                echo "[?] $exploit: Unexpected exit code $exit_code"
                ;;
        esac
    fi
done

echo ""
echo "[+] Quick test completed"
echo "[+] For detailed analysis, use: ./scripts/run_exploits.sh <exploit_name> --debug --log --monitor"