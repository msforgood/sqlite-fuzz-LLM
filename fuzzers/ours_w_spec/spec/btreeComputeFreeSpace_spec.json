{
  "target": {
    "function": "btreeComputeFreeSpace",
    "fc": "btree_003",
    "category": "B-Tree",
    "file": "btree.c",
    "line": 2091
  },
  "struct_spec": {
    "mempage": {
      "isInit": "u8",
      "intKey": "u8",
      "intKeyLeaf": "u8",
      "pgno": "Pgno",
      "leaf": "u8",
      "hdrOffset": "u8",
      "childPtrSize": "u8",
      "max1bytePayload": "u8",
      "nOverflow": "u8",
      "maxLocal": "u16",
      "minLocal": "u16",
      "cellOffset": "u16",
      "nFree": "int",
      "nCell": "u16",
      "maskPage": "u16",
      "pBt": "BtShared*",
      "aData": "u8*",
      "aDataEnd": "u8*",
      "aCellIdx": "u8*",
      "aDataOfst": "u8*",
      "pDbPage": "DbPage*"
    },
    "btshared": {
      "usableSize": "u32",
      "pageSize": "u32",
      "mutex": "sqlite3_mutex*",
      "db": "sqlite3*"
    },
    "page_header": {
      "freeblock_offset": "u16",
      "cell_count": "u16",
      "cell_content_offset": "u16",
      "fragmented_bytes": "u8",
      "rightmost_pointer": "u32"
    },
    "freeblock": {
      "next_offset": "u16",
      "size": "u16"
    }
  },
  "validation_spec": {
    "memory_align": 8,
    "page_size": {"min": 512, "max": 65536},
    "usable_size": {"min": 480, "max": 65504},
    "header_offset": [0, 100],
    "cell_pointer_size": [0, 4],
    "free_space_range": {"min": 0, "max": 65504},
    "freeblock_min_size": 4,
    "cell_content_min_offset": 8,
    "page_states": ["INITIALIZED", "CORRUPTED", "VALID"],
    "mutex_required": true
  },
  "fc_mapping": {
    "source": "btree.c:2091",
    "rationale": "btreeComputeFreeSpace - Critical free space calculation function for B-Tree page management",
    "api_level": "internal"
  },
  "constraints": {
    "max_input_size": 2048,
    "min_input_size": 32,
    "endianness": "LE",
    "sqlite_version": "3.51.0",
    "requires_initialization": true,
    "requires_page_init": true,
    "requires_mutex": true
  },
  "notes": {
    "preconditions": [
      "sqlite3_initialize() called",
      "Valid MemPage object with isInit=1",
      "BtShared mutex held",
      "Page data initialized and valid",
      "pPage->nFree < 0 (needs computation)"
    ],
    "side_effects": [
      "Updates pPage->nFree field",
      "May detect page corruption",
      "Validates freeblock chain integrity",
      "Computes total available free space"
    ],
    "error_conditions": [
      "SQLITE_CORRUPT_PAGE: Invalid freeblock structure",
      "SQLITE_CORRUPT_PAGE: Freeblock extends past page end",
      "SQLITE_CORRUPT_PAGE: Freeblocks not in ascending order",
      "SQLITE_CORRUPT_PAGE: Free space calculation overflow",
      "SQLITE_OK: Normal completion"
    ],
    "corruption_scenarios": [
      "Malformed freeblock chain",
      "Overlapping freeblocks",
      "Freeblock size inconsistencies",
      "Invalid header offsets",
      "Cell content area corruption",
      "Free space calculation overflow"
    ],
    "coverage_targets": [
      "Freeblock chain traversal",
      "Header validation logic",
      "Boundary condition checks",
      "Corruption detection paths",
      "Free space calculation",
      "Cell area validation"
    ]
  }
}